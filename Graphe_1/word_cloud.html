<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuages de mots Instagram</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .word-cloud-container {
            margin-bottom: 20px;
        }

        .word-cloud-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .word-cloud-description {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .word-cloud-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .word-cloud-col {
            flex: 1 1 calc(25% - 10px);
            margin-right: 10px;
        }

        @media screen and (max-width: 1200px) {
            .word-cloud-col {
                flex-basis: calc(33.33% - 10px);
            }
        }

        @media screen and (max-width: 900px) {
            .word-cloud-col {
                flex-basis: calc(50% - 10px);
            }
        }

        @media screen and (max-width: 600px) {
            .word-cloud-col {
                flex-basis: calc(100% - 10px);
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <script>
        document.addEventListener("DOMContentLoaded", function(event) {
            // Lire le fichier JSON
            d3.json("../combined_data.json").then(function(data) {

                // Fonction pour extraire les mots des commentaires
                function extractWords(comment) {
                    return comment.replace(/[^\w\s]|_/g, "").split(/\s+/).filter(function(word) {
                        return word.length > 0; // Filtrer les mots vides
                    });
                }

                // Fonction pour créer un nuage de mots
                function createWordCloud(data, postId, container) {
                    var wordFrequency = {};
                    data.forEach(function(comment) {
                        var words = extractWords(comment.COMMENTS.toLowerCase());
                        words.forEach(function(word) {
                            if (word in wordFrequency) {
                                wordFrequency[word]++;
                            } else {
                                wordFrequency[word] = 1;
                            }
                        });
                    });

                    // Trier les mots par fréquence et ne sélectionner que les 50 premiers
                    var sortedWords = Object.keys(wordFrequency).sort(function(a, b) {
                        return wordFrequency[b] - wordFrequency[a];
                    }).slice(0, 50); // Sélectionner les 50 premiers mots

                    var maxFrequency = d3.max(Object.values(wordFrequency)); // Fréquence maximale des mots

                    // Calculer la taille maximale de la police en fonction de la largeur de l'écran
                    var screenWidth = window.innerWidth;
                    var maxFontSize = Math.min(30, screenWidth / 20); // Limiter à une taille maximale de 30px
                    var fontSizeScale = d3.scaleLinear()
                        .domain([0, maxFrequency])
                        .range([10, maxFontSize]); // Ajuster la taille de la police en fonction de la fréquence

                    var wordsArray = sortedWords.map(function(word) {
                        return { text: word, size: fontSizeScale(wordFrequency[word]) };
                    });

                    var width = 400; // Largeur du conteneur SVG
                    var height = 200; // Hauteur du conteneur SVG
                    var svg = container.append("svg")
                        .attr("width", width)
                        .attr("height", height);

                    var color = d3.scaleOrdinal(d3.schemeCategory10);

                    // Créer les éléments textuels pour les mots
                    svg.selectAll("text")
                        .data(wordsArray)
                        .enter().append("text")
                        .style("font-size", function(d) { return d.size + "px"; })
                        .style("font-family", "Impact")
                        .style("fill", function(d, i) { return color(i); })
                        .attr("text-anchor", "middle")
                        .attr("transform", function(d, i) {
                            return "translate(" + [Math.random() * width, Math.random() * height] + ")";
                        })
                        .text(function(d) { return d.text; });
                }

                // Fonction pour regrouper les commentaires par post
                function groupCommentsByPost(comments) {
                    var groupedComments = {};
                    comments.forEach(function(comment) {
                        var postId = comment.file_identifier;
                        if (!groupedComments[postId]) {
                            groupedComments[postId] = [];
                        }
                        groupedComments[postId].push(comment);
                    });
                    return groupedComments;
                }

                // Créer un nuage de mots pour chaque groupe de commentaires
                var groupedComments = groupCommentsByPost(data);
                var screenWidth = window.innerWidth;

                var container = d3.select("body").append("div")
                    .attr("class", "word-cloud-row");

                var colIndex = 0;
                for (var postId in groupedComments) {
                    var col = container.append("div")
                        .attr("class", "word-cloud-col")
                        .attr("id", "word-cloud-" + postId);

                    col.append("div")
                        .attr("class", "word-cloud-title")
                        .text("Nuage de mots pour le post #" + postId);

                    col.append("div")
                        .attr("class", "word-cloud-description")
                        .text("Les 50 mots les plus fréquents dans les commentaires :");

                    createWordCloud(groupedComments[postId], postId, col);

                    colIndex++;
                    if (colIndex >= 4 || (screenWidth <= 1200 && colIndex >= 3) || (screenWidth <= 900 && colIndex >= 2) || (screenWidth <= 600 && colIndex >= 1)) {
                        container = d3.select("body").append("div")
                            .attr("class", "word-cloud-row");
                        colIndex = 0;
                    }
                }

            }).catch(function(error) {
                console.error("Erreur lors de la lecture du fichier JSON:", error);
            });
        });
    </script>
</body>
</html>
